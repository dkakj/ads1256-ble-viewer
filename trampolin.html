<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trampolinsensor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
 :root {
  --primary-color: #003366;
  --accent-color: #FF6600;
  --bg-color: #f9f9f9;
  --text-color: #333;
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-color);
  margin: 0;
  padding: 0;
}

header, footer {
  background-color: var(--primary-color);
  color: white;
  padding: 1em;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

header h1 {
  margin: 0;
  font-size: 1.5em;
}

.connect-link {
  color: white;
  text-decoration: underline;
  cursor: pointer;
  font-size: 1em;
  margin-top: 0.5em;
}

main {
  text-align: center;
  padding: 2em 1em;
}

#actual {
  font-size: 2em;
  margin: 1.5em 0;
  color: var(--primary-color);
}

canvas {
  width: 100% !important;
  max-width: 700px;
  margin: 2em auto;
  background: white;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.05);
}

footer {
  font-size: 0.9em;
  justify-content: center;
  gap: 1em;
  text-align: center;
}

/* Responsive tweaks */
@media (max-width: 600px) {
  header, footer {
    flex-direction: column;
    text-align: center;
  }

  header h1 {
    font-size: 1.2em;
  }

  .connect-link {
    font-size: 0.95em;
  }

  #actual {
    font-size: 1.5em;
  }
}

</style>
</head>
<body>
  <header>
    <h1>Trampolinsensor</h1>
    <span class="connect-link" onclick="connect()">Connect to Sensor</span>
  </header>

  <main>
    <div id="actual">Actual: -- kg</div>
    <canvas id="currentChart"></canvas>
    <canvas id="previousChart"></canvas>
  </main>

  <footer>
    <div>&copy; 2025 Trampolinsensor</div>
    <div>Powered by Bluetooth</div>
  </footer>

  <script>
    const SERVICE_UUID = '12345678-1234-1234-1234-1234567890ab';
    const KG_UUID = 'feedfeed-1234-5678-1234-feedfeedfeed';
    const JSON_UUID = 'abcdefab-1234-5678-1234-abcdefabcdef';

    const maxLabelPlugin = {
      id: 'maxLabelPlugin',
      afterDatasetsDraw(chart) {
        const ctx = chart.ctx;
        chart.data.datasets.forEach((dataset, datasetIndex) => {
          const meta = chart.getDatasetMeta(datasetIndex);
          const data = dataset.data;
          const maxValue = Math.max(...data);
          const maxIndex = data.indexOf(maxValue);
          const point = meta.data[maxIndex];

          if (point) {
            ctx.save();
            ctx.fillStyle = 'red';
            ctx.font = 'bold 12px sans-serif';
            ctx.fillText(`Max: ${maxValue}`, point.x, point.y - 10);
            ctx.restore();
          }
        });
      }
    };

    let currentChart, previousChart;

    async function connect() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);

        const kgChar = await service.getCharacteristic(KG_UUID);
        const jsonChar = await service.getCharacteristic(JSON_UUID);

        await kgChar.startNotifications();
        await jsonChar.startNotifications();

        kgChar.addEventListener('characteristicvaluechanged', handleKg);
        jsonChar.addEventListener('characteristicvaluechanged', handleJson);

        setupCharts();
      } catch (error) {
        console.error(error);
        alert('Connection failed: ' + error);
      }
    }

    function handleKg(event) {
      const raw = new TextDecoder().decode(event.target.value);
      const kg = parseFloat(raw);
      if (!isNaN(kg)) {
        document.getElementById('actual').textContent = `Actual: ${kg.toFixed(2)} kg`;
      }
    }

    function handleJson(event) {
      const raw = new TextDecoder().decode(event.target.value);
      try {
        const json = JSON.parse(raw);
        if (Array.isArray(json.previous)) {
          updateChart(previousChart, json.previous);
        } else if (Array.isArray(json.current)) {
          updateChart(currentChart, json.current);
        }
      } catch (e) {
        console.error("JSON parse error:", e.message);
      }
    }

    function setupCharts() {
      if (currentChart) currentChart.destroy();
      if (previousChart) previousChart.destroy();

      const ctx1 = document.getElementById('currentChart').getContext('2d');
      const ctx2 = document.getElementById('previousChart').getContext('2d');

      currentChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: Array.from({ length: 50 }, (_, i) => i),
          datasets: [{
            label: 'Current',
            data: [],
            borderColor: '#003366',
            backgroundColor: 'rgba(0, 51, 102, 0.1)',
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 4
          }]
        },
        options: { responsive: true, animation: false },
        plugins: [maxLabelPlugin]
      });

      previousChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: Array.from({ length: 50 }, (_, i) => i),
          datasets: [{
            label: 'Previous',
            data: [],
            borderColor: '#FF6600',
            backgroundColor: 'rgba(255, 102, 0, 0.1)',
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 4
          }]
        },
        options: { responsive: true, animation: false },
        plugins: [maxLabelPlugin]
      });
    }

    function updateChart(chart, dataArray) {
      chart.data.datasets[0].data = dataArray;
      chart.update();
    }
  </script>
</body>
</html>
