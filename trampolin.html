<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trampolinsensor.</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
 :root {
  --primary-color: #003366;
  --accent-color: #FF6600;
  --bg-color: #f9f9f9;
  --text-color: #333;
}

@media (max-width: 600px) {
  header h1 {
    font-size: 4em;
  }
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-color);
  margin: 0;
  padding: 0;
   overflow-x: hidden;
}


header, footer {
  background-color: var(--primary-color);
  color: white;
  padding: 1em;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

header h1 {
  margin: 0;
  font-size: 2em;
}

.connect-link {
  color: white;
  text-decoration: underline;
  cursor: pointer;
  font-size: 1.5em;
  margin-top: 0.5em;
}

main {
  text-align: center;
  padding: 2em 1em;
}

#actual {
  font-size: 1.5em;
  margin: 0.5em 0;
  color: var(--primary-color);
}

canvas {
  width: 100vw !important;
  height: auto !important;
  margin: 0.2em 0;
  background: white;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.05);
  display: block;
}


footer {
  font-size: 0.9em;
  justify-content: center;
  gap: 1em;
  text-align: center;
}

/* Responsive tweaks */
@media (max-width: 600px) {
  header, footer {
    flex-direction: column;
    text-align: center;
  }

  header h1 {
    font-size: 1.2em;
  }

  .connect-link {
    font-size: 0.95em;
  }

  #actual {
    font-size: 1.5em;
  }
}
.chart-container {
  display: flex;
  flex-wrap: wrap;
  gap: 2em;
  justify-content: center;
  align-items: flex-start;
  margin-top: 0em;
}

.chart-container canvas {
  width: 100%;
  max-width: 700px;
  aspect-ratio: 4 / 3;
  height: auto;
}

/* Stack charts vertically on small screens */
@media (max-width: 600px) {
  .chart-container {
    flex-direction: column;
    align-items: center;
  }
}

@media (min-width: 1024px) {
  .actual-value {
    margin: 0.8em 0; /* reduce vertical spacing */
  }
}
</style>
</head>
<body>
<header>
  <h1>Trampolinsensor</h1>
  <div style="display: flex; gap: 1em;">
    <span class="connect-link" onclick="connect()">Connect</span>
    <span class="connect-link" onclick="resetTop3()">Reset Max</span>
  </div>
</header>

  <main>
    
    <div class="chart-container">
      <canvas id="currentChart"></canvas>
      <canvas id="previousChart"></canvas>
    </div>
    <div id="top3" style="margin-top: 0.25em;">
      
      <h2>Top 3</h2>
      <ul id="maxList" style="list-style: none; padding: 0; font-size: 1.50em;"></ul>
      <div id="actual">-- kg</div>
    </div>
    
  </main>

  <footer>
    <div>&copy; 2025 Delayed By LK-Tech.dk</div>
  </footer>

  <script>
    let top3Values = [];

    const SERVICE_UUID = '12345678-1234-1234-1234-1234567890ab';
    const KG_UUID = 'feedfeed-1234-5678-1234-feedfeedfeed';
    const JSON_UUID = 'abcdefab-1234-5678-1234-abcdefabcdef';
    const SPEED_UUID = 'feedfeed-1234-5678-1234-feedfeed9876';

	const maxLabelPlugin = {
	  id: 'maxKgLabelPlugin',
	  afterDraw(chart) {
		const ctx = chart.ctx;
		const chartArea = chart.chartArea;
		const data = chart.data.datasets[0]?.data || [];
		const maxKg = Math.max(...data);
		const maxKgText = `Max kg: ${maxKg.toFixed(2)}`;

		ctx.save();
		ctx.font = 'bold 16px sans-serif';
		ctx.fillStyle = '#000000';
		ctx.textAlign = 'right';

		// Draw just above speed label
		ctx.fillText(maxKgText, chartArea.right - 10, chartArea.bottom - 30);
		ctx.restore();
	  }
	};
	  

	const speedLabelPlugin = {
	  id: 'speedLabelPlugin',
	  afterDraw(chart) {
		const ctx = chart.ctx;
		const chartArea = chart.chartArea;
		const speedText = window.latestSpeedText || '-- km/h';

		ctx.save();
		ctx.font = 'bold 16px sans-serif';
		ctx.fillStyle = '#000000';
		ctx.textAlign = 'right';

		// Draw inside chart area, bottom-right
		ctx.fillText(speedText, chartArea.right - 10, chartArea.bottom - 10);
		ctx.restore();
	  }
	};
    let currentChart, previousChart;

    async function connect() {
      try {
  
        if (!navigator.bluetooth) {
          alert("Web Bluetooth er ikke understøttet på denne enhed eller browser :-(");
        }
        try {
          const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [SERVICE_UUID] }]
          });
  
          const server = await device.gatt.connect();
          const service = await server.getPrimaryService(SERVICE_UUID);
  
          const kgChar = await service.getCharacteristic(KG_UUID);
          const jsonChar = await service.getCharacteristic(JSON_UUID);
  
          await kgChar.startNotifications();
          await jsonChar.startNotifications();
  
          kgChar.addEventListener('characteristicvaluechanged', handleKg);
          jsonChar.addEventListener('characteristicvaluechanged', handleKgArray);
          
          const speedChar = await service.getCharacteristic(SPEED_UUID);
          await speedChar.startNotifications();
          speedChar.addEventListener('characteristicvaluechanged', handleSpeed);
        }
        
        catch (error) {
          console.error("Bluetooth error:", error.name, error.message);
          alert(`Connection failed: ${error.name} - ${error.message}`);
        }

        setupCharts();
      } catch (error) {
        console.error(error);
        alert('Connection failed: ' + error);
      }
    }

    function handleKg(event) {
      const raw = new TextDecoder().decode(event.target.value);
      const kg = parseFloat(raw);
      if (!isNaN(kg)) {
        document.getElementById('actual').textContent = `${kg.toFixed(2)} kg`;
      }
    }
    function handleSpeed(event) {
        const raw = new TextDecoder().decode(event.target.value);
        const speedValue = parseFloat(raw);
      
        console.log("Received speed raw:", raw); 
      console.log("Received speed:", speedValue); 

        if (!isNaN(speedValue)) {
            //document.getElementById('speedDisplay').textContent = `Hastighed: ${speedValue.toFixed(2)} km/h`;
             // Update plugin text for chart
             window.latestSpeedText = `${speedValue.toFixed(2)} km/h`;

            // Refresh chart to trigger plugin draw
            if (currentChart) currentChart.update('none'); // 'none' to avoid full re-render
        }
    }

	 let receivedCount = 0;

	function handleKgArray(event) {
	  const text = new TextDecoder().decode(event.target.value);
	  const pairs = text.split(','); // ["0:0.10", "1:0.12", ...]

	  pairs.forEach(pair => {
		const [indexStr, valueStr] = pair.split(':');
		const index = parseInt(indexStr);
		const value = parseFloat(valueStr);

		if (isNaN(index) || isNaN(value)) return;

		if (index === 0) {
		  // Reset counter and copy previous chart
		  receivedCount = 0;
		  previousChart.data.datasets[0].data = [...currentChart.data.datasets[0].data];
		}

		currentChart.data.datasets[0].data[index] = value;
		receivedCount++;

		console.log("Received array:", index, value);

		
		
		previousChart.update();
		currentChart.update();
		// When all 50 values are received
		if (receivedCount === 50) {		
		updateTop3(currentChart.data.datasets[0].data);
		}
	  });
	}

    function setupCharts() {
      if (currentChart) currentChart.destroy();
      if (previousChart) previousChart.destroy();

      const ctx1 = document.getElementById('currentChart').getContext('2d');
      const ctx2 = document.getElementById('previousChart').getContext('2d');

      currentChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: Array.from({ length: 50 }, (_, i) => i),
          datasets: [{
            label: 'Current',
            data: [],
            borderColor: '#003366',
            backgroundColor: 'rgba(0, 51, 102, 0.1)',
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 4
          }]
        },
        options: { responsive: true, animation: false },
        plugins: [maxLabelPlugin,speedLabelPlugin]
      });

      previousChart = new Chart(ctx2, {
        type: 'line',
        data: {
          labels: Array.from({ length: 50 }, (_, i) => i),
          datasets: [{
            label: 'Previous',
            data: [],
            borderColor: '#FF6600',
            backgroundColor: 'rgba(255, 102, 0, 0.1)',
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 4
          }]
        },
        options: { responsive: true, animation: false },
        plugins: [maxLabelPlugin,speedLabelPlugin]
      });
    }

    function updateChart(chart, dataArray) {
      chart.data.datasets[0].data = dataArray;
      chart.update();
    }

function updateTop3(dataArray) {
  const maxInData = Math.max(...dataArray.filter(v => typeof v === 'number' && !isNaN(v)));

  // If no valid number found, exit
  if (isNaN(maxInData)) return;

  top3Values.push(maxInData);

  // Sort descending and keep only top 3
  top3Values = top3Values
    .sort((a, b) => b - a)
    .slice(0, 3);

  // Update UI
  const list = document.getElementById('maxList');
  list.innerHTML = '';
  top3Values.forEach((value, index) => {
    const li = document.createElement('li');
    li.textContent = `#${index + 1}: ${value.toFixed(2)} kg`;
    list.appendChild(li);
  });
}




function resetTop3() {
  top3Values = [];
  const list = document.getElementById('maxList');
  list.innerHTML = '<li style="color:gray;">Max values reset.</li>';
}


    
  </script>
</body>
</html>
